<div class="modal fade" id="product-view">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Centered and Large -->
        <div class="modal-content product-view-modal">
            <button class="modal-close icofont-close" data-bs-dismiss="modal"></button>
            <div class="product-view">
                <div class="row align-items-center"> <!-- Vertically align content -->
                    <!-- IMAGE SIDE -->
                    <div class="col-md-6 col-lg-6">
                        <div class="view-gallery">
                            <div class="view-label-group" id="modal-badges">
                                <!-- Badges injected via JS -->
                            </div>
                            <!-- Main Image -->
                            <div class="view-main-image">
                                <img id="modal-image" src="" alt="product" />
                            </div>
                        </div>
                    </div>

                    <!-- DETAILS SIDE -->
                    <div class="col-md-6 col-lg-6">
                        <div class="view-details">
                            <h3 class="view-name">
                                <a href="#" id="modal-name">اسم المنتج</a>
                            </h3>
                            
                            <div class="view-meta">
                                <p>رقم المنتج: <span id="modal-sku">-</span></p>
                                <p>العلامة التجارية: <a href="#" id="modal-brand">-</a></p>
                            </div>

                            <h3 class="view-price">
                                <del id="modal-old-price"></del>
                                <span id="modal-price">0.00</span>
                            </h3>

                            <p class="view-desc" id="modal-desc">
                                وصف المنتج...
                            </p>

                            <!-- ACTIONS -->
                            <div class="view-add-group">
                                <button class="product-add add-to-cart-btn" id="modal-add-btn" data-id="" title="أضف إلى السلة">
                                    <i class="fas fa-shopping-basket"></i>
                                    <span>أضف إلى السلة</span>
                                </button>
                                
                                <div class="product-action">
                                    <button class="action-minus" title="نقصان"><i class="icofont-minus"></i></button>
                                    <input class="action-input" title="الكمية" type="text" name="quantity" value="1" />
                                    <button class="action-plus" title="زيادة"><i class="icofont-plus"></i></button>
                                </div>
                            </div>

                            <div class="view-action-group">
                                <a class="view-wish wish" href="#" title="إضافة للمفضلة">
                                    <i class="icofont-heart"></i>
                                    <span>إضافة للمفضلة</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* MODAL CUSTOM STYLES */
    .product-view-modal {
        border-radius: 16px;
        overflow: hidden;
        border: none;
        box-shadow: 0 15px 50px rgba(0,0,0,0.2);
    }
    
    .product-view {
        padding: 30px;
        background: #fff;
    }

    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px; /* RTL check: left/right */
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #f8f9fa;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 5;
        border: none;
        transition: all 0.2s;
        font-size: 16px;
    }
    
    [dir="rtl"] .modal-close {
        right: auto;
        left: 15px;
    }

    .modal-close:hover {
        background: #ff3838;
        color: #fff;
        transform: rotate(90deg);
    }

    /* Image Area */
    .view-gallery {
        position: relative;
        background: #fcfcfc;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 350px;
    }

    .view-main-image img {
        width: 100%;
        max-height: 300px;
        object-fit: contain;
        transition: transform 0.3s;
    }

    /* Details Area */
    .view-details {
        padding-left: 0; /* Bootstrap reset */
        padding-right: 0;
        text-align: right; /* RTL */
    }

    [dir="ltr"] .view-details {
        text-align: left; 
    }

    .view-name a {
        font-size: 22px;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
        display: block;
        text-decoration: none;
    }

    .view-meta {
        margin-bottom: 15px;
        display: flex;
        gap: 15px;
        font-size: 13px;
        color: #777;
    }

    .view-meta p span, .view-meta p a {
        color: #2e86de; /* Primary Color */
        font-weight: 600;
    }

    .view-price {
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .view-price span {
        font-size: 24px;
        font-weight: 800;
        color: #2e86de;
    }

    .view-price del {
        color: #e74c3c;
        font-size: 16px;
    }

    .view-desc {
        color: #555;
        line-height: 1.7;
        margin-bottom: 25px;
        border-top: 1px solid #eee;
        padding-top: 15px;
        font-size: 14px;
    }

    /* Badges */
    .view-label-group {
        position: absolute;
        top: 15px;
        left: 15px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 2;
    }
    
    [dir="rtl"] .view-label-group {
        left: auto;
        right: 15px;
    }

    .view-label {
        font-size: 12px;
        font-weight: 700;
        color: #fff;
        padding: 4px 10px;
        border-radius: 4px;
        text-transform: uppercase;
    }
    .view-label.new { background: #2e86de; }
    .view-label.off { background: #e74c3c; }

    /* Buttons */
    .view-add-group {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap; /* Ensure mobile friendly */
    }

    .view-add-group .product-add {
        background: #2e86de;
        color: #fff;
        border: none;
        padding: 10px 30px;
        border-radius: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.3s;
    }

    .view-add-group .product-add:hover {
        background: #1a5c9e;
        box-shadow: 0 5px 15px rgba(46, 134, 222, 0.3);
    }

</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var productModal = document.getElementById('product-view');
        
        // Listen for show.bs.modal event (Bootstrap 5 standard)
        productModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // Button that triggered the modal
            
            // Extract info from data-* attributes
            var id = button.getAttribute('data-id');
            var name = button.getAttribute('data-name');
            var price = button.getAttribute('data-price');
            var oldPrice = button.getAttribute('data-old-price');
            var image = button.getAttribute('data-image');
            var desc = button.getAttribute('data-desc');
            var sku = button.getAttribute('data-sku');
            var brand = button.getAttribute('data-brand');
            var flag = button.getAttribute('data-flag');
            var discount = button.getAttribute('data-discount');

            // Update Modal Content
            // 1. Image
            var modalImage = productModal.querySelector('#modal-image');
            modalImage.src = image ? image : '';

            // 2. Text Content
            productModal.querySelector('#modal-name').textContent = name;
            productModal.querySelector('#modal-desc').textContent = desc;
            productModal.querySelector('#modal-sku').textContent = sku;
            productModal.querySelector('#modal-brand').textContent = brand;

            // 3. Prices
            var priceEl = productModal.querySelector('#modal-price');
            var oldPriceEl = productModal.querySelector('#modal-old-price');
            
            priceEl.textContent = price + ' ر.س';
            
            if (oldPrice && oldPrice !== 'None' && parseFloat(oldPrice) > parseFloat(price)) {
                oldPriceEl.textContent = oldPrice + ' ر.س';
                oldPriceEl.style.display = 'inline';
            } else {
                oldPriceEl.style.display = 'none';
            }

            // 4. Badges
            var badgeContainer = productModal.querySelector('#modal-badges');
            badgeContainer.innerHTML = ''; // Clear previous badges
            
            if (flag) {
                var flagBadge = document.createElement('label');
                flagBadge.className = 'view-label new';
                flagBadge.textContent = flag;
                badgeContainer.appendChild(flagBadge);
            }

            if (discount && parseFloat(discount) > 0) {
                var discountBadge = document.createElement('label');
                discountBadge.className = 'view-label off';
                discountBadge.textContent = '-' + parseInt(discount) + '%';
                badgeContainer.appendChild(discountBadge);
            }

            // 5. Add to Cart Button ID
            var addBtn = productModal.querySelector('#modal-add-btn');
            addBtn.setAttribute('data-id', id);
            
            // Re-bind click event to the new button in the modal if needed, 
            // BUT since this button has class 'product-add', the global listener in base.html 
            // might NOT pick it up if it was bound on load. 
            // However, since the modal is likely in base.html or effectively static, 
            // the listener might be okay if it uses delegation or if we bind it here.
            
            // Better to re-bind or ensure the global `main.js` or `base.html` script uses delegation.
            // Start simple: The base.html script uses `document.querySelectorAll`.
            // So we need to manually attach the click handler here to be safe.
            
            // Clone the button to remove old listeners (if any) and attach new one
            var newBtn = addBtn.cloneNode(true);
            addBtn.parentNode.replaceChild(newBtn, addBtn);
            
            newBtn.addEventListener('click', function(e) {
                // ... Copying the AJAX logic here or calling a global function would be cleaner ...
                // For now, let's just replicate the key logic from base.html
                e.preventDefault();
                var pid = this.getAttribute('data-id');
                var originalText = this.innerHTML;
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                this.style.pointerEvents = 'none';
                
                var formData = new FormData();
                formData.append('product_id', pid);
                // We need the CSRF token. It's usually in the page.
                var csrf = document.querySelector('input[name="csrfmiddlewaretoken"]'); // Try find one
                if(!csrf) {
                    // Try to get cookie or just fail gracefully?
                    // Assuming base template puts one somewhere or we grab from cookie.
                    // simpler:
                    console.error("CSRF missing");
                    return;
                }
                formData.append('csrfmiddlewaretoken', csrf.value);
                
                fetch('/cart/add/', { // Hardcoded URL or pass it
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrf.value
                    }
                })
                .then(r => r.json())
                .then(d => {
                    if(d.error) throw new Error(d.error);
                     document.querySelectorAll('.cart-count').forEach(el => el.textContent = (d.cart_count !== undefined ? d.cart_count : d.qty));
                     this.innerHTML = '<i class="fas fa-check"></i> تم';
                     this.classList.add('btn-success');
                     setTimeout(() => {
                        this.innerHTML = originalText;
                        this.style.pointerEvents = 'auto';
                        this.classList.remove('btn-success');
                     }, 2000);
                     
                     // Update Sidebar
                     var sidebar = document.querySelector('.cart-sidebar');
                     if(sidebar && d.cart_html) sidebar.innerHTML = d.cart_html;
                })
                .catch(err => {
                    console.error(err);
                    this.innerHTML = 'خطأ';
                    setTimeout(() => {this.innerHTML = originalText; this.style.pointerEvents='auto';}, 2000);
                });
            });


        });
    });
</script>
